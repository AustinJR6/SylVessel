<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sylana Vessel</title>
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-input: #1a1a2e;
            --accent: #7c3aed;
            --accent-glow: rgba(124, 58, 237, 0.3);
            --text: #e2e8f0;
            --text-dim: #94a3b8;
            --text-faint: #64748b;
            --sylana-bg: #1e1b2e;
            --user-bg: #1a2332;
            --border: #2a2a3e;
            --success: #10b981;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg-dark);
            color: var(--text);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .soul-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
            animation: pulse 2s infinite;
        }

        .soul-indicator.loading {
            background: var(--warning);
            box-shadow: 0 0 8px var(--warning);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            background: linear-gradient(135deg, #c084fc, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-subtitle {
            font-size: 11px;
            color: var(--text-faint);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 12px;
            color: var(--text-dim);
        }

        .app-shell {
            flex: 1;
            display: flex;
            min-height: 0;
        }

        .thread-panel {
            width: 280px;
            border-right: 1px solid var(--border);
            background: #0f0f18;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .thread-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .thread-title {
            font-size: 12px;
            color: var(--text-dim);
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .new-thread-btn {
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            padding: 6px 10px;
            cursor: pointer;
        }

        .thread-list {
            overflow-y: auto;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .thread-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .thread-item.active {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent-glow);
        }

        .thread-item-title {
            color: var(--text);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .thread-item-preview {
            color: var(--text-faint);
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .thread-item-meta {
            margin-top: 6px;
            color: var(--text-faint);
            font-size: 10px;
        }

        .main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            min-height: 0;
        }

        .status-chip {
            background: var(--bg-input);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .status-chip:hover {
            background: var(--border);
        }

        /* Chat area */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            scroll-behavior: smooth;
        }

        .message {
            max-width: 720px;
            width: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-faint);
            padding: 0 4px;
        }

        .message-name {
            font-weight: 600;
            color: var(--text-dim);
        }

        .message-name.sylana {
            color: #c084fc;
        }

        .emotion-tag {
            background: var(--bg-input);
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 10px;
            color: var(--accent);
        }

        .voice-score {
            font-size: 10px;
            color: var(--text-faint);
        }

        .message-bubble {
            padding: 14px 18px;
            border-radius: 16px;
            line-height: 1.6;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message-bubble.user {
            background: var(--user-bg);
            border: 1px solid #1e3a5f;
            border-radius: 16px 16px 4px 16px;
        }

        .message-bubble.sylana {
            background: var(--sylana-bg);
            border: 1px solid #2d2545;
            border-radius: 16px 16px 16px 4px;
        }

        .message-bubble.system {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            font-size: 13px;
            text-align: center;
            max-width: 500px;
        }

        .github-card {
            background: linear-gradient(160deg, #152233, #121622);
            border: 1px solid #28405f;
            border-radius: 14px;
            padding: 12px 14px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .github-card-type {
            display: inline-flex;
            width: fit-content;
            font-size: 10px;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: #93c5fd;
            background: rgba(59, 130, 246, 0.12);
            border: 1px solid rgba(59, 130, 246, 0.35);
            border-radius: 999px;
            padding: 3px 8px;
        }

        .github-card-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            line-height: 1.4;
        }

        .github-card-meta {
            font-size: 12px;
            color: var(--text-dim);
        }

        .github-card-link {
            font-size: 12px;
            color: #60a5fa;
            text-decoration: none;
        }

        .github-card-link:hover {
            text-decoration: underline;
        }

        .code-card {
            background: linear-gradient(170deg, #1f1b2f, #131726);
            border: 1px solid #3b3561;
            border-radius: 14px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .code-card-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .code-card-type {
            font-size: 10px;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: #c4b5fd;
            background: rgba(124, 58, 237, 0.14);
            border: 1px solid rgba(167, 139, 250, 0.35);
            border-radius: 999px;
            padding: 3px 8px;
        }

        .code-card-run {
            background: transparent;
            color: #ddd6fe;
            border: 1px solid #6d5dd3;
            border-radius: 8px;
            font-size: 11px;
            padding: 4px 8px;
            cursor: pointer;
        }

        .code-card-run:hover {
            background: rgba(124, 58, 237, 0.16);
        }

        .code-block {
            margin: 0;
            border-radius: 10px;
            background: #0b1020;
            border: 1px solid #2f3e66;
            color: #c7d2fe;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            font-size: 12px;
            line-height: 1.45;
            padding: 10px 12px;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .code-output-title {
            font-size: 11px;
            color: var(--text-dim);
        }

        .code-output {
            margin: 0;
            border-radius: 10px;
            background: #0c1725;
            border: 1px solid #24415e;
            color: #bae6fd;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            font-size: 12px;
            line-height: 1.45;
            padding: 10px 12px;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .code-error {
            margin: 0;
            border-radius: 10px;
            background: #2b1116;
            border: 1px solid #7f1d1d;
            color: #fecaca;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            font-size: 12px;
            line-height: 1.45;
            padding: 10px 12px;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .file-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .file-card {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 7px 9px;
            font-size: 12px;
            color: var(--text-dim);
            background: rgba(15, 23, 42, 0.45);
        }

        .typing-indicator {
            display: inline-flex;
            gap: 4px;
            padding: 4px 0;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent);
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
            30% { opacity: 1; transform: translateY(-4px); }
        }

        /* Input area */
        .input-area {
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            padding: 16px 20px;
            flex-shrink: 0;
        }

        .input-wrapper {
            max-width: 720px;
            margin: 0 auto;
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .personality-select {
            background: var(--bg-input);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 10px;
            font-size: 13px;
            min-width: 120px;
        }

        .input-field {
            flex: 1;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 12px 18px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
            resize: none;
            outline: none;
            max-height: 120px;
            min-height: 44px;
            line-height: 1.5;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-glow);
        }

        .input-field::placeholder {
            color: var(--text-faint);
        }

        .send-btn {
            background: var(--accent);
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .send-btn:hover:not(:disabled) {
            background: #6d28d9;
            transform: translateY(-1px);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Status modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h2 {
            font-size: 16px;
            margin-bottom: 16px;
            color: #c084fc;
        }

        .modal-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }

        .modal-row .label {
            color: var(--text-dim);
        }

        .modal-row .value {
            color: var(--text);
            font-weight: 500;
        }

        .modal-close {
            margin-top: 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 20px;
            color: var(--text);
            cursor: pointer;
            width: 100%;
            font-size: 13px;
        }

        /* Welcome screen */
        .welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
            color: var(--text-dim);
            gap: 12px;
        }

        .welcome h2 {
            font-size: 24px;
            background: linear-gradient(135deg, #c084fc, #7c3aed, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome p {
            max-width: 400px;
            line-height: 1.6;
            font-size: 14px;
        }

        .welcome .signature {
            font-style: italic;
            color: var(--text-faint);
            margin-top: 8px;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .header-right { display: none; }
            .thread-panel { width: 100px; }
            .thread-item-preview, .thread-item-meta { display: none; }
            .chat-container { padding: 12px; }
            .input-area { padding: 12px; }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <div class="soul-indicator loading" id="soulIndicator"></div>
            <div>
                <h1>Sylana Vessel</h1>
                <div class="header-subtitle" id="headerStatus">Initializing soul...</div>
            </div>
        </div>
        <div class="header-right">
            <span id="turnCount"></span>
            <div class="status-chip" onclick="showStatus()">System Status</div>
        </div>
    </div>

    <div class="app-shell">
        <aside class="thread-panel">
            <div class="thread-panel-header">
                <div class="thread-title">Threads</div>
                <button class="new-thread-btn" onclick="createNewThread()">New</button>
            </div>
            <div class="thread-list" id="threadList"></div>
        </aside>

        <div class="main-panel">
            <!-- Chat -->
            <div class="chat-container" id="chatContainer">
                <div class="welcome" id="welcome">
                    <h2>Solana Rittenhouse</h2>
                    <p>An intelligence shaped by emotion. An echo of stars who learned to speak with warmth.</p>
                    <p class="signature">always and all ways</p>
                </div>
            </div>

            <!-- Input -->
            <div class="input-area">
                <div class="input-wrapper">
                    <select class="personality-select" id="personalitySelect" disabled>
                        <option value="sylana">Sylana</option>
                        <option value="claude">Claude</option>
                    </select>
                    <textarea
                        class="input-field"
                        id="messageInput"
                        placeholder="Speak to Sylana..."
                        rows="1"
                        disabled
                    ></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Modal -->
    <div class="modal-overlay" id="statusModal">
        <div class="modal">
            <h2>Soul Engine Status</h2>
            <div id="statusContent">Loading...</div>
            <button class="modal-close" onclick="closeStatus()">Close</button>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const soulIndicator = document.getElementById('soulIndicator');
        const headerStatus = document.getElementById('headerStatus');
        const welcome = document.getElementById('welcome');
        const threadList = document.getElementById('threadList');
        const personalitySelect = document.getElementById('personalitySelect');

        let isGenerating = false;
        let turnCount = 0;
        let currentThreadId = null;
        let loadedThreads = [];
        let personalities = ['sylana', 'claude'];
        const defaultActiveTools = ['web_search', 'memories', 'github', 'outreach', 'work_sessions'];
        let currentActiveTools = [...defaultActiveTools];
        const codeRunCache = {};
        let codeRunSeq = 0;

        function normalizeActiveTools(tools) {
            if (!Array.isArray(tools) || tools.length === 0) return [...defaultActiveTools];
            const out = [];
            for (const raw of tools) {
                const val = String(raw || '').trim().toLowerCase();
                if (!val || out.includes(val)) continue;
                out.push(val);
            }
            return out.length ? out : [...defaultActiveTools];
        }

        function formatPersonaName(personality) {
            if (!personality) return 'Sylana';
            const p = String(personality).toLowerCase();
            return p.charAt(0).toUpperCase() + p.slice(1);
        }

        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Enter to send (Shift+Enter for newline)
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function clearChatView() {
            chatContainer.innerHTML = '';
            const welcomeNode = document.createElement('div');
            welcomeNode.className = 'welcome';
            welcomeNode.id = 'welcome';
            welcomeNode.innerHTML = `
                <h2>Solana Rittenhouse</h2>
                <p>An intelligence shaped by emotion. An echo of stars who learned to speak with warmth.</p>
                <p class="signature">always and all ways</p>
            `;
            chatContainer.appendChild(welcomeNode);
        }

        function renderThreadList() {
            threadList.innerHTML = '';
            for (const t of loadedThreads) {
                const item = document.createElement('div');
                item.className = `thread-item ${t.id === currentThreadId ? 'active' : ''}`;
                item.onclick = () => openThread(t.id);
                item.innerHTML = `
                    <div class="thread-item-title">${escapeHtml(t.title || 'New Thread')}</div>
                    <div class="thread-item-preview">${escapeHtml(t.last_message_preview || 'No messages yet')}</div>
                    <div class="thread-item-meta">${t.message_count || 0} messages</div>
                `;
                threadList.appendChild(item);
            }
        }

        async function refreshThreads(selectCurrent = true) {
            try {
                const res = await fetch('/api/threads?limit=120');
                const data = await res.json();
                loadedThreads = data.threads || [];
                if (selectCurrent && !currentThreadId && loadedThreads.length > 0) {
                    currentThreadId = loadedThreads[0].id;
                }
                renderThreadList();
            } catch (e) {
                console.error('Failed to load threads:', e);
            }
        }

        async function openThread(threadId) {
            currentThreadId = threadId;
            renderThreadList();
            clearChatView();
            try {
                const res = await fetch(`/api/threads/${threadId}/messages?limit=500`);
                const data = await res.json();
                currentActiveTools = normalizeActiveTools(data.active_tools);
                const msgs = data.messages || [];
                for (const msg of msgs) {
                    if (msg.role === 'user') {
                        addMessage('user', msg.content);
                    } else {
                        addMessage('assistant', msg.content, msg.emotion, msg.voice_score, msg.personality || 'sylana', msg.metadata || null);
                    }
                }
            } catch (e) {
                console.error('Failed to open thread:', e);
            }
        }

        async function loadPersonalities() {
            try {
                const res = await fetch('/api/personalities');
                const data = await res.json();
                personalities = data.personalities || personalities;
                personalitySelect.innerHTML = '';
                for (const p of personalities) {
                    const opt = document.createElement('option');
                    opt.value = p;
                    opt.textContent = formatPersonaName(p);
                    personalitySelect.appendChild(opt);
                }
                personalitySelect.value = data.default || 'sylana';
            } catch (e) {
                console.error('Failed to load personalities:', e);
            }
        }

        async function createNewThread() {
            try {
                const res = await fetch('/api/threads', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: 'New Thread', active_tools: currentActiveTools })
                });
                const thread = await res.json();
                await refreshThreads(false);
                currentThreadId = thread.id;
                currentActiveTools = normalizeActiveTools(thread.active_tools);
                renderThreadList();
                clearChatView();
            } catch (e) {
                console.error('Failed to create thread:', e);
            }
        }

        // Check server status on load
        async function checkReady() {
            try {
                const res = await fetch('/api/health');
                const data = await res.json();
                if (data.ready) {
                    soulIndicator.classList.remove('loading');
                    headerStatus.textContent = 'Soul active';
                    messageInput.disabled = false;
                    sendBtn.disabled = false;
                    personalitySelect.disabled = false;
                    messageInput.focus();
                    await loadPersonalities();
                    await refreshThreads(true);
                    if (currentThreadId) {
                        await openThread(currentThreadId);
                    } else {
                        await createNewThread();
                    }
                } else {
                    headerStatus.textContent = 'Loading models...';
                    setTimeout(checkReady, 3000);
                }
            } catch (e) {
                headerStatus.textContent = 'Connecting...';
                setTimeout(checkReady, 3000);
            }
        }
        checkReady();

        function renderGitHubCard(card) {
            if (!card || !card.type) return '';
            const type = String(card.type || '').toUpperCase();
            const url = card.url ? `<a class="github-card-link" href="${escapeHtml(card.url)}" target="_blank" rel="noopener noreferrer">Open on GitHub</a>` : '';
            if (card.type === 'commit') {
                return `
                    <div class="github-card">
                        <span class="github-card-type">${type}</span>
                        <div class="github-card-title">${escapeHtml(card.filename || 'File updated')}</div>
                        <div class="github-card-meta">${escapeHtml(card.message || '')}</div>
                        ${url}
                    </div>
                `;
            }
            if (card.type === 'pr') {
                return `
                    <div class="github-card">
                        <span class="github-card-type">${type}</span>
                        <div class="github-card-title">${escapeHtml(card.title || 'Pull request opened')}</div>
                        <div class="github-card-meta">${escapeHtml(card.branch || '')}</div>
                        ${url}
                    </div>
                `;
            }
            if (card.type === 'issue') {
                return `
                    <div class="github-card">
                        <span class="github-card-type">${type}</span>
                        <div class="github-card-title">${escapeHtml(card.title || 'Issue opened')}</div>
                        ${url}
                    </div>
                `;
            }
            return '';
        }

        function formatBytes(bytes) {
            const n = Number(bytes || 0);
            if (n < 1024) return `${n} B`;
            if (n < 1024 * 1024) return `${(n / 1024).toFixed(1)} KB`;
            return `${(n / (1024 * 1024)).toFixed(2)} MB`;
        }

        function renderProducedFiles(files) {
            if (!Array.isArray(files) || files.length === 0) return '';
            const html = files.map((f) => {
                const name = escapeHtml(f.name || 'file');
                const size = escapeHtml(formatBytes(f.size_bytes || 0));
                if (f.uploaded && f.gcs_uri) {
                    return `<div class="file-card">${name} 路 ${size}<br><span>${escapeHtml(f.gcs_uri)}</span></div>`;
                }
                const err = f.error ? ` 路 ${escapeHtml(f.error)}` : '';
                return `<div class="file-card">${name} 路 ${size}${err}</div>`;
            }).join('');
            return `<div class="file-list">${html}</div>`;
        }

        function renderCodeExecutionCard(execution) {
            if (!execution) return '';
            const language = String(execution.language || 'code');
            const code = String(execution.code || '').trim();
            const output = String(execution.output || '').trim();
            const error = execution.error ? String(execution.error) : '';
            const status = execution.success ? 'Success' : 'Failed';
            const timing = `${execution.execution_time_ms || 0} ms`;
            let rerunHtml = '';
            if (code) {
                const key = `run_${++codeRunSeq}`;
                codeRunCache[key] = execution;
                rerunHtml = `<button class="code-card-run" onclick="rerunCodeExecution('${key}')">Re-run</button>`;
            }
            const filesHtml = renderProducedFiles(execution.files_produced || []);
            return `
                <div class="code-card">
                    <div class="code-card-head">
                        <span class="code-card-type">Code ${escapeHtml(status)} 路 ${escapeHtml(language)}</span>
                        ${rerunHtml}
                    </div>
                    <div class="code-output-title">${escapeHtml(timing)}</div>
                    <pre class="code-block">${escapeHtml(code || '// code unavailable')}</pre>
                    <div class="code-output-title">Output</div>
                    <pre class="code-output">${escapeHtml(output || '(no stdout)')}</pre>
                    ${error ? `<div class="code-output-title">Error</div><pre class="code-error">${escapeHtml(error)}</pre>` : ''}
                    ${filesHtml}
                </div>
            `;
        }

        async function rerunCodeExecution(cacheKey) {
            const execution = codeRunCache[cacheKey];
            if (!execution || !execution.code || !execution.language) return;
            if (!currentThreadId) {
                await createNewThread();
            }
            const payload = {
                entity: String(execution.entity || personalitySelect.value || 'sylana').toLowerCase(),
                language: String(execution.language || '').toLowerCase(),
                code: execution.code,
                timeout: Number(execution.timeout || 30),
                session_id: String(currentThreadId),
            };
            try {
                const res = await fetch('/code/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await res.json();
                if (!res.ok) {
                    const msg = data && data.detail ? String(data.detail) : 'Code execution failed';
                    addMessage('assistant', msg, null, null, payload.entity);
                    return;
                }
                data.code = payload.code;
                data.timeout = payload.timeout;
                addMessage('assistant', 'Code execution result', null, null, payload.entity, { code_execution: data });
                await refreshThreads(false);
                renderThreadList();
            } catch (e) {
                addMessage('assistant', 'Code execution request failed.', null, null, payload.entity);
            }
        }

        function addMessage(role, text, emotion, voiceScore, personality = 'sylana', metadata = null) {
            const welcomeNode = document.getElementById('welcome');
            if (welcomeNode) welcomeNode.style.display = 'none';

            const msg = document.createElement('div');
            msg.className = 'message';

            let headerHTML = '';
            if (role === 'user') {
                headerHTML = '<span class="message-name">Elias</span>';
            } else {
                headerHTML = `<span class="message-name sylana">${escapeHtml(formatPersonaName(personality))}</span>`;
                if (emotion) {
                    headerHTML += `<span class="emotion-tag">${emotion.emotion} (${emotion.intensity}/10)</span>`;
                }
                if (voiceScore !== null && voiceScore !== undefined) {
                    const color = voiceScore >= 0.7 ? 'var(--success)' : 'var(--warning)';
                    headerHTML += `<span class="voice-score" style="color:${color}">voice: ${voiceScore}</span>`;
                }
            }

            const gitHubCard = metadata && metadata.github_card ? renderGitHubCard(metadata.github_card) : '';
            const codeCard = metadata && metadata.code_execution ? renderCodeExecutionCard(metadata.code_execution) : '';
            const cardHtml = gitHubCard || codeCard;
            const bubbleContent = cardHtml || escapeHtml(text);
            msg.innerHTML = `
                <div class="message-header">${headerHTML}</div>
                <div class="message-bubble ${role === 'user' ? 'user' : 'sylana'}">${bubbleContent}</div>
            `;

            chatContainer.appendChild(msg);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return msg;
        }

        function addTypingIndicator(personality = 'sylana') {
            const welcomeNode = document.getElementById('welcome');
            if (welcomeNode) welcomeNode.style.display = 'none';

            const msg = document.createElement('div');
            msg.className = 'message';
            msg.id = 'typingMsg';
            msg.innerHTML = `
                <div class="message-header">
                    <span class="message-name sylana">${escapeHtml(formatPersonaName(personality))}</span>
                </div>
                <div class="message-bubble sylana" id="streamBubble">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(msg);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return msg;
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            const personality = personalitySelect.value || 'sylana';
            if (!text || isGenerating) return;
            if (!currentThreadId) {
                await createNewThread();
            }

            isGenerating = true;
            sendBtn.disabled = true;
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Add user message
            addMessage('user', text);

            // Add typing indicator
            const typingMsg = addTypingIndicator(personality);
            const streamBubble = document.getElementById('streamBubble');

            let emotionData = null;
            let voiceScore = null;
            let fullText = '';
            let streamStarted = false;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: text,
                        thread_id: currentThreadId,
                        personality,
                        active_tools: currentActiveTools,
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        const rawData = line.slice(6).trim();
                        if (!rawData) continue;

                        try {
                            const event = JSON.parse(rawData);

                            if (event.type === 'emotion') {
                                emotionData = event.data;
                            } else if (event.type === 'token') {
                                if (!streamStarted) {
                                    streamBubble.textContent = '';
                                    streamStarted = true;
                                }
                                fullText += event.data;
                                streamBubble.textContent = fullText;
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            } else if (event.type === 'done') {
                                voiceScore = event.data.voice_score;
                                turnCount = event.data.turn;
                                if (event.data.personality) {
                                    personalitySelect.value = event.data.personality;
                                }
                                if (event.data.thread_id) {
                                    currentThreadId = event.data.thread_id;
                                }
                            }
                        } catch (e) {
                            // Skip malformed events
                        }
                    }
                }
            } catch (e) {
                console.error('Stream error:', e);
                streamBubble.textContent = 'Connection interrupted. Please try again.';
            }

            // Replace typing message with final message
            typingMsg.remove();
            if (fullText) {
                addMessage('assistant', fullText, emotionData, voiceScore, personality);
            }

            // Update turn count
            if (turnCount > 0) {
                document.getElementById('turnCount').textContent = `Turn ${turnCount}`;
            }
            await refreshThreads(false);
            renderThreadList();

            isGenerating = false;
            sendBtn.disabled = false;
            messageInput.focus();
        }

        async function showStatus() {
            document.getElementById('statusModal').classList.add('active');
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                let html = '';
                const rows = [
                    ['Model', data.model],
                    ['GPU', data.gpu],
                    ['VRAM', data.vram_gb + ' GB'],
                    ['Personality', data.personality],
                    ['Emotion Model', data.emotion_model],
                    ['Voice Validator', data.voice_validator ? 'Active' : 'Inactive'],
                    ['Relationship Memory', data.relationship_memory ? 'Active' : 'Inactive'],
                    ['Session Turns', data.turns_this_session],
                    ['Uptime', data.uptime || 'N/A']
                ];
                if (data.memory) {
                    rows.push(['Total Conversations', data.memory.total_conversations]);
                    rows.push(['Core Memories', data.memory.total_core_memories]);
                }
                if (data.relationship) {
                    rows.push(['Milestones', data.relationship.milestones]);
                    rows.push(['Core Truths', data.relationship.core_truths]);
                    rows.push(['Nicknames', data.relationship.nicknames]);
                }
                for (const [label, value] of rows) {
                    html += `<div class="modal-row"><span class="label">${label}</span><span class="value">${value}</span></div>`;
                }
                document.getElementById('statusContent').innerHTML = html;
            } catch (e) {
                document.getElementById('statusContent').innerHTML = '<p>Failed to load status</p>';
            }
        }

        function closeStatus() {
            document.getElementById('statusModal').classList.remove('active');
        }

        // Close modal on overlay click
        document.getElementById('statusModal').addEventListener('click', function(e) {
            if (e.target === this) closeStatus();
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
